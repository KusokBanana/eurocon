(function(b){var a={init:function(){this.messenger=b("#messages");this.messages=this.messenger.find("#msg-container");this.conversations=b("#conversations");this.messenger.get(0).scrollTop=this.messenger.get(0).scrollHeight},registerListeners:function(){var c=this;b(document).ready(function(){var g=c.messages.get(0).scrollHeight;var e=b("#messages-loader");var f=b("#conversations-loader");var d=function(){var k=c.conversations.yiiSimpleChatConversations("widget").current;if(k.newMessages!==undefined&&k.newMessages.count){var i=c.conversations.yiiSimpleChatConversations("find",k.contact.id,"contact");if(i.length){i.find(".conversation-read").trigger("click")}else{c.conversations.yiiSimpleChatConversations("read")}}var j=/\/(\s*\d+\s*)$/;if(!location.href.match(j)){var h=location.href+"/"+k.contact.id;window.history.replaceState(null,document.title,h)}c.messenger.off("initialized",d)};c.conversations.on("initialized",d).on("scroll",function(){if(!c.conversations.data("loaded")){if(c.conversations.get(0).scrollTop+c.conversations.innerHeight()>=c.conversations.get(0).scrollHeight){c.conversations.yiiSimpleChatConversations("load",8)}}}).on("click",".conversation:not(.active)",function(){var j=b(this);e.show();var l=b.extend({},c.messenger.yiiSimpleChatMessages("widget"));c.messenger.yiiSimpleChatMessages("destroy");c.messenger.removeData("loaded");var m={contact:j.data("contactinfo"),deleteUrl:j.data("deleteurl"),readUrl:j.data("readurl"),unreadUrl:j.data("unreadurl"),loadUrl:j.data("loadurl"),sendUrl:j.data("sendurl")};l.settings.loadUrl=m.loadUrl;l.settings.sendUrl=m.sendUrl;c.messenger.yiiSimpleChatMessages(l.user,m.contact,l.settings);var k=function(){b(".loading").show();c.messenger.off("beforeSend.load",k)};c.messenger.on("beforeSend.load",k);var i=function(){b(".loading").hide();c.messenger.off("complete.load",i)};c.messenger.on("complete.load",i);var h=function(){j.addClass("active").siblings(".active").removeClass("active");c.conversations.yiiSimpleChatConversations("widget").current=m;if(j.find(".conversation-read").length){j.find(".conversation-read").trigger("click")}document.title=m.contact.name;var o=/\/(\s*\d+\s*)/;var n=location.href.replace(o,"/"+m.contact.id);window.history.replaceState(null,document.title,n);c.messenger.off("success.load",h);e.hide()};c.messenger.on("success.load",h);c.messenger.yiiSimpleChatMessages("reload",{type:"fullReload"});j.find(".conversation-read").trigger("click")}).on("click",".conversation .conversation-read",function(j){j.preventDefault();j.stopPropagation();var i=b(this);var h=i.parents(".conversation");c.conversations.yiiSimpleChatConversations("read",{url:h.data("readurl"),success:function(k){if(k.count&&h.length){i.remove()}}})}).on("beforeSend.load",function(i,h){if(h==="history"){f.show()}}).on("complete.load",function(i,h){if(h==="history"){f.hide()}}).on("success.load",function(n,k,m){var l=c.conversations.yiiSimpleChatConversations("widget");var j,i;if(k==="history"){if(m.totalCount===m.models.length){c.conversations.data("loaded",true)}for(j=0;j<m.models.length;j++){i={model:m.models[j],key:m.keys[j],index:j,user:l.user,isCurrent:l.current.contact.id===m.models[j]["contact"]["id"],settings:l.settings};c.conversations.yiiSimpleChatConversations("append",i)}}else{for(j=m.models.length-1;j>=0;j--){i={model:m.models[j],key:m.keys[j],index:j,user:l.user,isCurrent:l.current.contact.id===m.models[j]["contact"]["id"],settings:l.settings};var h=c.conversations.yiiSimpleChatConversations("find",i.model.contact.id,"contact");if(h.length){h.remove()}c.conversations.yiiSimpleChatConversations("prepend",i)}}});c.messenger.on("click","#historyBtn",function(){if(c.messenger.get(0).scrollTop===0&&!c.messenger.data("loaded")){c.messenger.yiiSimpleChatMessages("load",10);b(this).remove()}});c.messenger.on("beforeSend.load",function(i,h){if(h==="history"){g=c.messenger.get(0).scrollHeight;e.show()}}).on("complete.load",function(i,h){if(h==="history"){e.hide();c.messenger.get(0).scrollTop=c.messenger.get(0).scrollHeight-g}}).on("success.load",function(m,o,i){var n=false,r=c.messenger.yiiSimpleChatMessages("widget");var l,h;if(o==="history"){c.messenger.yiiSimpleChatMessages("prepend",i)}else{if(o==="fullReload"){c.messenger.yiiSimpleChatMessages(o,i);c.messenger.get(0).scrollTop=c.messenger.get(0).scrollHeight}else{var p=c.messenger.yiiSimpleChatMessages("find",".chat-content").last();if(p){n=p.attr("data-when")}var k=false;for(l=i.models.length-1;l>=0;l--){if(i.models[l]["when"]!==n){n=i.models[l]["when"];c.messenger.yiiSimpleChatMessages("append",'<p class="time">'+n+"</p>")}var q=i.models[l]["sender_id"];h={model:i.models[l],key:i.keys[l],index:l,user:r.user,sender:q===r.user.id?r.user:r.contact,settings:r.settings};if(q===r.contact.id){k=true}c.messenger.yiiSimpleChatMessages("append",h)}if(k){var j=c.conversations.yiiSimpleChatConversations("find",r.contact.id,"contact");if(j.length){j.find(".conversation-read").trigger("click")}}if(i.models.length>0){c.messenger.get(0).scrollTop=c.messenger.get(0).scrollHeight}}}}).on("success.send",function(i,h){if(h.length===0){c.messenger.yiiSimpleChatMessages("resetForm");c.messenger.yiiSimpleChatMessages("load","new");c.conversations.yiiSimpleChatConversations("load","new")}else{console.error(h)}});b("#msg-send").click(function(h){h.preventDefault();b("#msg-form").trigger("submit")});b("#msg-input").on("keydown",function(h){if(h.keyCode===13){b("#msg-form").trigger("submit")}});setInterval(function(){c.messenger.yiiSimpleChatMessages("load","new")},10000);setInterval(function(){c.conversations.yiiSimpleChatConversations("load","new")},15000)})}};a.init();a.registerListeners()})(jQuery);