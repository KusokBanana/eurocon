(function(f){f.fn.yiiSimpleChatMessages=function(i){if(c[i]){return c[i].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof i==="object"||!i){return c.init.apply(this,arguments)}else{f.error("Method "+i+" does not exist on jQuery.yiiSimpleChatMessages");return false}}};var a=null;var e={up:"history",down:"new"};var d={init:"initialized",send:{beforeSend:"beforeSend.send",complete:"complete.send",error:"error.send",success:"success.send"},load:{beforeSend:"beforeSend.load",complete:"complete.load",error:"error.load",success:"success.load"}};var g={loadUrl:"",loadMethod:"GET",sendUrl:false,renderUrl:false,sendMethod:false,limit:10,templateUrl:"",itemCssClass:"msg"};var c={init:function(j,i,k){return this.each(function(){var n=f(this);if(n.data("yiiSimpleChatMessages")){return}var m=f.extend({},g,k||{});n.data("yiiSimpleChatMessages",{settings:m,user:j,contact:i,status:0});var l=f(m.form);l.on("submit.yiiSimpleChatMessages",function(o){o.preventDefault();c.send.apply(n)});if(m.sendUrl){l.attr("action",m.sendUrl)}if(m.sendMethod){l.attr("method",m.sendMethod)}n.trigger(d.init)})},resetForm:function(){var k=f(this);var j=k.data("yiiSimpleChatMessages");var i=f(j.settings.form);i.find("input, textarea, select").each(function(){var l=f(this);l.val("")})},send:function(){var l=f(this);var k=l.data("yiiSimpleChatMessages");var i=f(k.settings.form);var j=i.attr("action");f.ajax({url:j,type:i.attr("method"),dataType:"JSON",data:i.serialize(),beforeSend:function(n,m){l.trigger(d.send.beforeSend,[n,m])},complete:function(m,n){l.trigger(d.send.complete,[m,n])},success:function(m){l.trigger(d.send.success,[m])},error:function(n,o,m){l.trigger(d.send.error,[n,o,m])}})},reload:function(i){var j=(i!==undefined&&i.type)?i.type:"reload";var k=f(this);c.resetForm.apply(k);c.empty.apply(k);c.load.apply(k,[{type:j}])},load:function(j){var n=f(this);var m=n.data("yiiSimpleChatMessages");var l={type:e.up,limit:m.settings.limit};if(typeof j==="number"){l.limit=j}else{if(typeof j==="string"){l.type=j}else{l=f.extend({},l,j||{})}}var k=h(n,l.type===e.up?"first":"last");if(k){l.key=k.data("key")}var i=m.settings.loadUrl;if(m.status===0){f.ajax({url:i,type:m.settings.loadMethod,dataType:"JSON",data:l,beforeSend:function(p,o){m.status=1;n.trigger(d.load.beforeSend,[l.type,p,o])},complete:function(o,p){m.status=0;n.trigger(d.load.complete,[l.type,o,p])},success:function(o,q,p){n.trigger(d.load.success,[l.type,o,q,p])},error:function(p,q,o){n.trigger(d.load.error,[l.type,p,q,o])}})}},empty:function(){var k=f(this);var i=k.data("yiiSimpleChatMessages");var j=k.find(i.settings.container);j.empty()},fullReload:function(j){var l=f(this);var i=l.data("yiiSimpleChatMessages");var k=l.find(i.settings.container);k.empty().append(j)},append:function(m){var o=f(this);var l=o.data("yiiSimpleChatMessages");var n=o.find(l.settings.container);if(typeof m==="object"){m=b(l.settings.templateUrl,m)}var j=f(m),i=h(o,"last"),k=j.attr("data-sender");if(i&&i.length&&!i.closest(".msg").next().length&&i.closest(".msg").attr("data-sender")===k){i.after(j.find(".chat-content"))}else{n.append(m)}},prepend:function(j){var l=f(this);var i=l.data("yiiSimpleChatMessages");var k=l.find(i.settings.container);if(typeof j=="object"){k.prepend(b(i.settings.templateUrl,j))}else{k.prepend(j)}},insert:function(n,i,m){var p=f(this);var l=p.data("yiiSimpleChatMessages");var o=p.find(l.settings.container);var j=o.find(i);var k=null;if(typeof n=="object"){k=b(l.settings.templateUrl,n)}else{k=n}if(m){j.before(k)}else{j.after(k)}},destroy:function(){return this.each(function(){var k=f(this);var j=k.data("yiiSimpleChatMessages");var i=f(j.settings.form);i.off(".yiiSimpleChatMessages");k.removeData("yiiSimpleChatMessages")})},widget:function(){return this.data("yiiSimpleChatMessages")},find:function(j){var i=f(this);return h(i,j)}};var h=function(k,l){var i=k.data("yiiSimpleChatMessages");var j=k.find(i.settings.container);if(typeof l=="number"){return j.find("[data-key="+l+"]").parent(".msg")}else{if(l=="last"){return j.find("."+i.settings.itemCssClass).last().find(".chat-content").last()}else{if(l=="first"){return j.find("."+i.settings.itemCssClass).first().find(".chat-content").first()}else{return j.find(l)}}}};var b=function(i,j){f.ajax({url:j.settings.renderUrl,type:"POST",data:{id:"message",href:i,data:j},async:false,success:function(k){a=k}});return a}})(jQuery);